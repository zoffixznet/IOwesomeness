# FINAL Report / Perl 6 IO TPF Grant

This document is the May, 2017 progress report for [TPF Standardization,
Test Coverage, and Documentation of Perl 6 I/O Routines
grant](http://news.perlfoundation.org/2017/01/grant-proposal-standardization.html). I believe I reasonably satisfied the goals of the grant and consider it
completed. This is the final report and may reference some of the
work/commits previously mentioned in monthly reports.

# Completeness Criteria

Here are the original completeness criteria (in bold) that are listed on the
original grant and my comments on their status:

- **rakudo repository will contain the IO Action Plan document and it will
  be fully implemented.**
  The promised [document
  exists](https://github.com/rakudo/rakudo/blob/nom/docs/2017-IO-Grant--Action-Plan.md). It's fully implemented except for three items that I listed on the
  IO Action Plan, but which are currently a bit beyond my skill level to
  implement. I hope to do them eventually, but outside the scope of this grant.
  These are:
  - [IO::Handle's Closed status](https://github.com/rakudo/rakudo/blob/nom/docs/2017-IO-Grant--Action-Plan.md#iohandles-closed-status-issue-for-discussion). My original proposal
  would cause some perfomance issues, so it was decided to improve MoarVM
  errors instead.
  - [Optimize multiple stat calls](https://github.com/rakudo/rakudo/blob/nom/docs/2017-IO-Grant--Action-Plan.md#iopath-routines-that-involve-a-stat-call-issue-for-discussion). This
  involves creating a new nqp op, with code for it implemented in MoarVM and
  JVM backends.
  - [Use typed exceptions instead of X::AdHoc](https://github.com/rakudo/rakudo/blob/nom/docs/2017-IO-Grant--Action-Plan.md#use-typed-exceptions-instead-of-xadhoc-issue-for-discussion). I
  made typed exceptions be thrown whereever I could. The rest require VM-level
  exceptions and is on the same level as the handle closed status issue
  (first item above).
- **All of the I/O routines will have tests in roast and documented on
  docs.perl6.org. If any of the currently implemented but unspecced routines
  are decided against being included in Perl 6 Language, their implementation
  will no longer be available in Rakudo.**
  To the best of my knowledge, this is completed in full.
- **The test coverage tool will report all I/O routines as covered and the
  information will be visible on [perl6.wtf](https://perl6.wtf) (Perl 6's
  Wonderful Test Files)
  website. Note: due to current experimental status of the coverage tool, its
  report may still show some lines or conditionals untested despite them
  actually being tested; however, it will show the lines where routines' names
  are specified as covered.**
  To the best of my knowledge, all IO routines currently have tests covering
  them. Due to its experimental status, the coverage tool shows some
  attributes as uncovered. I did manually verify all the attributes/routines
  whose names the tool shows as uncovered contain tests for them.
  One exception is `IO::Notification` type (and `IO::Path.watch` method).
  While it has full coverage for
  OSX operating system, it lacks it for other OSes. I tried writing some, but
  it looks like the behaviour of the nqp op handling these is broken
  on Linux and the class needs more work.

# Extra Deliverables

I produced these extra deliverables while working on the grant:

- **[The Definitive I/O Guide](https://docs.perl6.org/language/io-guide).**
    Providing tutorial-like documentation for Perl 6's I/O, including some of
    the bad practices I noticed in the ecosystem (and even a Perl 6 book!).
- **Performance improvements.** I made 23 performance-enhancing commits, with
    many commits making things more than 200% faster, with highest improvement
    making a routine 6300% faster.
- **[`IO::Trait` module](https://github.com/zoffixznet/perl6-Trait-IO).**
    Provides `does auto-close` trait to simplify closing of IO handles.
- **[`IO::Path::ChildSecure` module](https://github.com/zoffixznet/perl6-IO-Path-ChildSecure).** Due to
    large ecosystem usage, `IO::Path.child` was left as is until 6.d language,
    at which point it will be made secure (as outlined in the IO Plan). This
    module provides the secure version in the mean time.
- **[`IO::Dir` module](https://github.com/zoffixznet/perl6-IO-Dir).** Provides
    `IO::Path.dir`-like functionality, with ability to close open directory
    without needing to fully exhaust the returned `Seq`.
- **[`Die` module](https://github.com/zoffixznet/perl6-Die).** Implements
    Perl-5-like behaviour for `&die` routine.
- **The "Map of Perl 6 Routines"** (or rather the "table") is available on
    [map.perl6.party](https://map.perl6.party/) with its code in
    [perl6/routine-map repo](https://github.com/perl6/routine-map). In near
    future, I plan to use it to identify incorrect or incomplete entries in
    our [documentation](https://docs.perl6.org)

In addition, I plan to complete these modules some time in the future; the
ideas for them were birthed while working on the grant:
- **`NL` module.** Targeted for use in one liners, the module will provide
  `$*NL` dynvar that behaves like Perl 5's `$.` variable (providing current
    `$*ARGFILES`'s file's line number). Its implementation became possible
    thanks to newly-implemented
    [`IO::CatHandle` type](https://docs.perl6.org/type/IO::CatHandle)
- **`FastIO` module.** A re-imagination of core IO, the biggest part of which
    will be removal of (user-exposed) use of `IO::Spec::*` types and `$*SPEC`
    variable, which—it is believed—will provide improved performance over
    core IO. The module is a prototype for some of the proposals that were
    made during the IO grant and if it offers significant improvements over
    core IO, its ideas will be used by core IO in future language versions.

##



## Tickets Fixed

- [RT#130456 `$*HOME blows up if HOME isn't set`](https://rt.perl.org/Ticket/Display.html?id=130456)
- [RT#126935 `bad .perl for paths with pipe characters`](https://rt.perl.org/Ticket/Display.html?id=126935) (was already fixed; just added an extra test)
- [RT#131185 IO::Path.perl doesn't roundtrip](https://rt.perl.org/Ticket/Display.html?id=131185)
- [RT#130454 tmpdir tries to change the current working directory](https://rt.perl.org/Ticket/Display.html?id=130454) (routine was removed as part of IO work)
- [RT#130455 Should I be able to change the temporary directory?](https://rt.perl.org/Ticket/Display.html?id=130455)
- [RT#130715 IO::Handle::close shouldn't decide what's a failure](https://rt.perl.org/Ticket/Display.html?id=130715) (not a bug, but user's confusion; explained and rejected)
- [RT#131242 IO::Path.move/.copy hangs/trashes file when target/source are same](https://rt.perl.org/Ticket/Display.html?id=131242)
