# Perl 6 IO TPF Grant: Monthly Report (March, 2017)

This document is the March, 2017 progress report for [TPF Standardization,
Test Coverage, and Documentation of Perl 6 I/O Routines
grant](http://news.perlfoundation.org/2017/01/grant-proposal-standardization.html)

## Timing

While my delivery of the Action Plan was one week later than I originally
expected to deliver it, the updated timing outlined in my last report is still
in place and I plan to complete this grant by April 15, 2017, with all of the
modifications completed prior to the next Rakudo compiler release (and
the Rakudo Star release that will be based on it).

Note: to minimize user impact, some of the changes may be included only in
6.d language, which will be available in 2017.04 release only if the user uses
`use v6.d.PREVIEW` pragma.

## IO Action Plan

XXX TODO: include link to plan, number of pages, and state of pre- post- review

I finished the Action Plan and made it available to other core devs for
review for a week. The Plan has now been finalized and I will start implementing
it shortly.

Overall, I proposed many more smaller changes than I originally expected and
fewer larger, breaking changes than I originally expected. This has to do
with a much better understanding of how rakudo's IO routines are "meant to" be
used, so I think the improvement of the documentation under this grant will
be much greater than I originally anticipated.

A lot of this has to do with lack of explanatory documentation for how to
manipulate and traverse paths. This had the effect that users were using the
`$*SPEC` object and its routines for that goal, which is rather awkward.
This concept is prevalent enough that I even wrote [`SPEC::Func`](https://github.com/zoffixznet/perl6-SPEC-Func) module in the
past, due to user demand, and certain books whose draft copies I read used
the `$*SPEC` as well.

In reality, `$*SPEC` is an internal-ish thing and unless you're writing your
own IO abstractions, you never need to use it directly. The changes and
additions to the `IO::Path` methods done under this grant will make traversing
paths even more pleasant, and the new tutorial documentation I plan to write
under this grant will fully describe the Right Way™ to do it all.

## newio Branch

As per original goals of the grant, I reviewed the code in Rakudo's 2014–2015
`newio` branch, to look for any salvagable ideas. I did not have any masterplan
design documents to go with it and I tried a few commits but did not find one
that didn't have merge conflicts and compiled, so my understanding of it comes
solely from reading the source code, and may be off from what the original
author intended it to be.

The major difference between `newio` and Rakudo's current IO structure is
type hierarchy. `newio` provides `IO::Pathy` and `PIO` roles which
are done by `IO::File`, `IO::Dir`, `IO::Local`, `IO::Dup`, `IO::Pipe`,
and `IO::Huh` classes that represent various IO objects. The current Rakudo's
system has fewer abstractions: `IO::Path` represents a path to an IO object and
`IO::Handle` provides read/write access to it, with `IO::Pipe` handling pipes,
and no special objects for directories (their contents are obtained via
`IO::Path.dir` method and their attributes are modified via `IO::Path`
methods).

Since 6.d language is *additive* to 6.c language, completely revamping the
type hierarchy may be challenging and messy. However, I would abstain from
`newio` paradigm largely based not on how difficult it would be to move to
current Rakudo but based on what looks to be one of the core design
principles in `newio`: all of the abstractions are of IO objects
as *they were at the instantiation time*.

An `IO::Pathy` object represents an IO item *that exists*, despite there being
no guarantees that it actually does. Thus, `IO::File`'s `.f` and `.e` methods
always return `True`, while its `.d` method always returns `False`. This
undoubtedly gives a performance enhancement, however, if
`$ rm foo` were executed after `IO::File` object's creation, the `.e` method
would no longer return correct data and if then `$ mkdir foo` were
executed, both `.f` and `.d` methods would be returning incorrect data.

Until recently, Rakudo cached the result of `.e` call and [that produced
unexpected by user behaviour](https://rt.perl.org/Ticket/Display.html?id=130889). And I think the
issue will be greatly exacerbated if this sort of caching is extended to entire
objects and many of their methods.

As such, my decision is to not use the ideas from the `newio` branch. And I'd
like to re-iterate that this is based on my limited understanding of its
design and the additive nature of 6.d language, and is not indicative of the
quality of the code in the branch.

## Bugs

The hunt for 6-legged friends has these finds so far:

#### Will (attempt to) fix as part of the grant


#### Don't think I will be able to fix these as part of the grant

- Found a strange error generated when `IO::Pipe`'s buffer is filled up.
This is too deep in the guts for me to know how to resolve yet, so I filed it as
    [RT#131026](https://rt.perl.org/Ticket/Display.html?id=131026)

#### Already Fixed

- Found that IO::Path had a vestigial .pipe method that delegated to a
    non-existant IO::Handle method. Removed in [rakudo/a01d67](https://github.com/rakudo/rakudo/commit/a01d6794d2d37b574011198cc4928f77f8c33361)
- Fixed IO::Pipe.lines not accepting a Whatever as limit, which is accepted by
    all other .lines. In addition, I was able to switch it to use the much
    faster IO::Handle.lines method, making it 3.2x faster. [rakudo/0c6281](https://github.com/rakudo/rakudo/commit/0c6281518e5c78113121968df0cf7404aa949dd3)
    Tests in [roast/465795](https://github.com/perl6/roast/commit/465795c458041e66e33e32e2de2b8cd358be5961) and [roast/add852](https://github.com/perl6/roast/commit/add852b082a2fca83dbefe03d890dd5939c5ff45)
- Fixed issues due to caching of `IO::Handle.e`. Reported as
    [RT#130889](https://rt.perl.org/Ticket/Display.html?id=130889). Fixed in
    [rakudo/76f718](https://github.com/rakudo/rakudo/commit/76f71878da61731f33b457e84c7b0e801c64af66).
    Tests in [roast/908348](https://github.com/perl6/roast/commit/908348eef18b1c33f1bd8d879b9bb16f002fb6f7)
- Rejected [rakudo PR#666](https://github.com/rakudo/rakudo/pull/666)
    and resolved [RT#126262](https://rt.perl.org/Ticket/Display.html?id=126262) by explaining why the methods return `Str` objects instead of `IO::Path` on
    ticket/PR and improving the documentation by
    fixing mistakes ([doc/ccae74](https://github.com/perl6/doc/commit/ccae74a1502285d8b82697b68a8e26a31ca762d7)) and expanding ([doc/3cf943](https://github.com/perl6/doc/commit/3cf943d86bef3744146e31e106815a00a2a81f4a)) on what the methods do exactly.
- IO::Path.Bridge was defunct, as it was trying to call .Bridge on Str, which
    does not exist. Resolved the issue by deleting this method in [rakudo/212cc8](https://github.com/rakudo/rakudo/commit/212cc8ae5d)
- Per demand, made `IO::Path.dir` a multi, so module-space can augment it with
    other candidates that add more functionality. [rakudo/fbe7ace](https://github.com/rakudo/rakudo/commit/fbe7ace6fc19d86ac1cb0519654e4239c1a17129)


#### Auxiliary Bugs

While doing the work for this grant, I also discovered some non-IO related bugs (some of which I fixed):
